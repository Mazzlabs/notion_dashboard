{% extends "base.html" %}

{% block title %}Assignments - Academic Management{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="assignmentsData()">
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-granite-800 mb-2">
                <span class="icon-assignment"></span>
                Assignments
            </h1>
            <p class="text-granite-600">Manage your coursework and track progress.</p>
        </div>
        <button @click="showCreateModal = true" class="btn btn-primary">
            <span class="icon-plus"></span>
            Add Assignment
        </button>
    </div>

    <!-- Filters and Search -->
    <div class="card mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0 md:space-x-4">
            <!-- Search -->
            <div class="flex-1 max-w-md">
                <div class="relative">
                    <span class="icon-search absolute left-3 top-1/2 transform -translate-y-1/2 text-granite-400"></span>
                    <input type="text" 
                           x-model="searchTerm" 
                           @input="filterAssignments"
                           placeholder="Search assignments..."
                           class="form-input pl-10">
                </div>
            </div>
            
            <!-- Filters -->
            <div class="flex space-x-4">
                <select x-model="filterStatus" @change="filterAssignments" class="form-select">
                    <option value="">All Status</option>
                    <option value="Not Started">Not Started</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Overdue">Overdue</option>
                </select>
                
                <select x-model="filterCourse" @change="filterAssignments" class="form-select">
                    <option value="">All Courses</option>
                    <template x-for="course in courses" :key="course">
                        <option :value="course" x-text="course"></option>
                    </template>
                </select>
                
                <select x-model="sortBy" @change="sortAssignments" class="form-select">
                    <option value="due_date">Sort by Due Date</option>
                    <option value="priority">Sort by Priority</option>
                    <option value="progress">Sort by Progress</option>
                    <option value="title">Sort by Title</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Assignments Grid -->
    <div x-show="filteredAssignments.length === 0" class="text-center py-12">
        <span class="icon-assignment text-6xl text-granite-400 block mb-4"></span>
        <h3 class="text-lg font-medium text-granite-900 mb-2">No assignments found</h3>
        <p class="text-granite-600 mb-6">Get started by creating your first assignment.</p>
        <button @click="showCreateModal = true" class="btn btn-primary">
            <span class="icon-plus"></span>
            Create Assignment
        </button>
    </div>

    <div x-show="filteredAssignments.length > 0" class="grid-responsive">
        <template x-for="assignment in filteredAssignments" :key="assignment.id">
            <div class="card hover:shadow-lg transition-all duration-200">
                <div class="card-header">
                    <div class="flex-1">
                        <h3 class="font-semibold text-granite-900" x-text="assignment.title"></h3>
                        <p class="text-sm text-granite-600" x-text="assignment.course"></p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button @click="editAssignment(assignment)" 
                                class="text-granite-400 hover:text-turquoise-600 transition-colors">
                            <span class="icon-edit"></span>
                        </button>
                        <button @click="deleteAssignment(assignment.id)" 
                                class="text-granite-400 hover:text-red-600 transition-colors">
                            <span class="icon-delete"></span>
                        </button>
                    </div>
                </div>
                
                <div class="card-content">
                    <!-- Assignment Details -->
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-granite-600">Type:</span>
                            <span class="text-sm font-medium" x-text="assignment.type"></span>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-granite-600">Due Date:</span>
                            <span class="text-sm font-medium" 
                                  :class="getDueDateClass(assignment.due_date)"
                                  x-text="formatDate(assignment.due_date)"></span>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-granite-600">Priority:</span>
                            <span class="text-sm font-medium" 
                                  :class="getPriorityClass(assignment.priority)"
                                  x-text="assignment.priority"></span>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-granite-600">Progress:</span>
                                <span class="text-sm font-medium" x-text="`${assignment.progress || 0}%`"></span>
                            </div>
                            <div class="w-full h-2 bg-granite-200 rounded-full">
                                <div class="h-2 rounded-full progress-fill"
                                     :class="getProgressClass(assignment.progress)"
                                     :style="`width: ${assignment.progress || 0}%`"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer">
                    <span class="status-badge" 
                          :class="getStatusClass(assignment.status)" 
                          x-text="assignment.status"></span>
                    <button @click="updateProgress(assignment)" class="btn btn-outline btn-sm">
                        Update Progress
                    </button>
                </div>
            </div>
        </template>
    </div>

    <!-- Create/Edit Assignment Modal -->
    <div x-show="showCreateModal || showEditModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="modal-overlay">
        <div class="modal-content" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform scale-90"
             x-transition:enter-end="opacity-100 transform scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform scale-100"
             x-transition:leave-end="opacity-0 transform scale-90">
            <div class="modal-header">
                <h3 class="modal-title" x-text="showEditModal ? 'Edit Assignment' : 'Create Assignment'"></h3>
                <button @click="closeModal()" 
                        class="text-granite-400 hover:text-granite-600 transition-colors">
                    <span class="icon-cross"></span>
                </button>
            </div>
            
            <form @submit.prevent="saveAssignment()" class="modal-body">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" x-model="formData.title" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Course</label>
                    <select x-model="formData.course" class="form-select" required>
                        <option value="">Select Course</option>
                        <template x-for="course in courses" :key="course">
                            <option :value="course" x-text="course"></option>
                        </template>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select x-model="formData.type" class="form-select" required>
                            <option value="">Select Type</option>
                            <option value="Essay">Essay</option>
                            <option value="Problem Set">Problem Set</option>
                            <option value="Quiz">Quiz</option>
                            <option value="Exam">Exam</option>
                            <option value="Project">Project</option>
                            <option value="Presentation">Presentation</option>
                            <option value="Lab Report">Lab Report</option>
                            <option value="Discussion">Discussion</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select x-model="formData.priority" class="form-select" required>
                            <option value="">Select Priority</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" x-model="formData.due_date" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Progress (%)</label>
                        <input type="number" x-model="formData.progress" min="0" max="100" class="form-input">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select x-model="formData.status" class="form-select" required>
                        <option value="">Select Status</option>
                        <option value="Not Started">Not Started</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                        <option value="On Hold">On Hold</option>
                    </select>
                </div>
            </form>
            
            <div class="modal-footer">
                <button @click="closeModal()" type="button" class="btn btn-outline">
                    Cancel
                </button>
                <button @click="saveAssignment()" type="button" class="btn btn-primary">
                    <span x-text="showEditModal ? 'Update' : 'Create'"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Progress Update Modal -->
    <div x-show="showProgressModal" 
         x-transition class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Update Progress</h3>
                <button @click="showProgressModal = false" 
                        class="text-granite-400 hover:text-granite-600 transition-colors">
                    <span class="icon-cross"></span>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Progress Percentage</label>
                    <input type="range" 
                           x-model="progressUpdate.progress" 
                           min="0" max="100" 
                           class="w-full h-2 bg-granite-200 rounded-lg appearance-none slider">
                    <div class="flex justify-between text-sm text-granite-600 mt-2">
                        <span>0%</span>
                        <span x-text="`${progressUpdate.progress}%`" class="font-medium"></span>
                        <span>100%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select x-model="progressUpdate.status" class="form-select">
                        <option value="Not Started">Not Started</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                        <option value="On Hold">On Hold</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-footer">
                <button @click="showProgressModal = false" type="button" class="btn btn-outline">
                    Cancel
                </button>
                <button @click="saveProgressUpdate()" type="button" class="btn btn-primary">
                    Update
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function assignmentsData() {
    return {
        assignments: [],
        filteredAssignments: [],
        courses: [],
        searchTerm: '',
        filterStatus: '',
        filterCourse: '',
        sortBy: 'due_date',
        showCreateModal: false,
        showEditModal: false,
        showProgressModal: false,
        currentAssignment: null,
        progressUpdate: { progress: 0, status: 'Not Started' },
        formData: {
            title: '',
            course: '',
            type: '',
            priority: '',
            due_date: '',
            progress: 0,
            status: 'Not Started'
        },
        
        init() {
            this.loadAssignments();
        },
        
        async loadAssignments() {
            try {
                const response = await fetch('/api/assignments');
                if (response.ok) {
                    this.assignments = await response.json();
                    this.extractCourses();
                    this.filterAssignments();
                }
            } catch (error) {
                console.error('Failed to load assignments:', error);
            }
        },
        
        extractCourses() {
            this.courses = [...new Set(this.assignments.map(a => a.course).filter(Boolean))];
        },
        
        filterAssignments() {
            let filtered = this.assignments;
            
            // Apply search filter
            if (this.searchTerm) {
                const term = this.searchTerm.toLowerCase();
                filtered = filtered.filter(a => 
                    a.title.toLowerCase().includes(term) ||
                    a.course.toLowerCase().includes(term) ||
                    a.type.toLowerCase().includes(term)
                );
            }
            
            // Apply status filter
            if (this.filterStatus) {
                filtered = filtered.filter(a => a.status === this.filterStatus);
            }
            
            // Apply course filter
            if (this.filterCourse) {
                filtered = filtered.filter(a => a.course === this.filterCourse);
            }
            
            this.filteredAssignments = filtered;
            this.sortAssignments();
        },
        
        sortAssignments() {
            this.filteredAssignments.sort((a, b) => {
                switch (this.sortBy) {
                    case 'due_date':
                        return new Date(a.due_date) - new Date(b.due_date);
                    case 'priority':
                        const priorityOrder = { 'Urgent': 4, 'High': 3, 'Medium': 2, 'Low': 1 };
                        return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
                    case 'progress':
                        return (b.progress || 0) - (a.progress || 0);
                    case 'title':
                        return a.title.localeCompare(b.title);
                    default:
                        return 0;
                }
            });
        },
        
        editAssignment(assignment) {
            this.currentAssignment = assignment;
            this.formData = { ...assignment };
            this.showEditModal = true;
        },
        
        updateProgress(assignment) {
            this.currentAssignment = assignment;
            this.progressUpdate = {
                progress: assignment.progress || 0,
                status: assignment.status
            };
            this.showProgressModal = true;
        },
        
        async saveAssignment() {
            try {
                const url = this.showEditModal 
                    ? `/api/assignments/${this.currentAssignment.id}`
                    : '/api/assignments';
                
                const method = this.showEditModal ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.formData)
                });
                
                if (response.ok) {
                    await this.loadAssignments();
                    this.closeModal();
                    this.showAlert('Assignment saved successfully!', 'success');
                } else {
                    this.showAlert('Failed to save assignment.', 'error');
                }
            } catch (error) {
                console.error('Failed to save assignment:', error);
                this.showAlert('Failed to save assignment.', 'error');
            }
        },
        
        async saveProgressUpdate() {
            try {
                const response = await fetch(`/api/assignments/${this.currentAssignment.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.progressUpdate)
                });
                
                if (response.ok) {
                    await this.loadAssignments();
                    this.showProgressModal = false;
                    this.showAlert('Progress updated successfully!', 'success');
                } else {
                    this.showAlert('Failed to update progress.', 'error');
                }
            } catch (error) {
                console.error('Failed to update progress:', error);
                this.showAlert('Failed to update progress.', 'error');
            }
        },
        
        async deleteAssignment(id) {
            if (!confirm('Are you sure you want to delete this assignment?')) return;
            
            try {
                const response = await fetch(`/api/assignments/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await this.loadAssignments();
                    this.showAlert('Assignment deleted successfully!', 'success');
                } else {
                    this.showAlert('Failed to delete assignment.', 'error');
                }
            } catch (error) {
                console.error('Failed to delete assignment:', error);
                this.showAlert('Failed to delete assignment.', 'error');
            }
        },
        
        closeModal() {
            this.showCreateModal = false;
            this.showEditModal = false;
            this.currentAssignment = null;
            this.formData = {
                title: '',
                course: '',
                type: '',
                priority: '',
                due_date: '',
                progress: 0,
                status: 'Not Started'
            };
        },
        
        getStatusClass(status) {
            const classes = {
                'Not Started': 'status-not-started',
                'In Progress': 'status-in-progress',
                'Completed': 'status-completed',
                'Overdue': 'status-overdue',
                'On Hold': 'status-on-hold'
            };
            return classes[status] || 'status-not-started';
        },
        
        getPriorityClass(priority) {
            const classes = {
                'Low': 'priority-low',
                'Medium': 'priority-medium',
                'High': 'priority-high',
                'Urgent': 'priority-urgent'
            };
            return classes[priority] || 'priority-medium';
        },
        
        getProgressClass(progress) {
            if (progress >= 80) return 'progress-high';
            if (progress >= 50) return 'progress-medium';
            return 'progress-low';
        },
        
        getDueDateClass(dueDate) {
            const date = new Date(dueDate);
            const now = new Date();
            const diffDays = Math.ceil((date - now) / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return 'text-red-600';
            if (diffDays <= 2) return 'text-orange-600';
            if (diffDays <= 7) return 'text-yellow-600';
            return 'text-granite-600';
        },
        
        formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        },
        
        showAlert(message, type) {
            // Simple alert for now - could be enhanced with a toast system
            alert(message);
        }
    }
}
</script>
{% endblock %}
